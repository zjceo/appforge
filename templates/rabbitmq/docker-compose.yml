version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq_${APP_NAME}
    restart: unless-stopped
    hostname: rabbitmq-${APP_NAME}
    environment:
      # Credenciales por defecto
      - RABBITMQ_DEFAULT_USER=${DB_USER}
      - RABBITMQ_DEFAULT_PASS=${DB_PASSWORD}
      
      # Virtual host
      - RABBITMQ_DEFAULT_VHOST=/
      
      # Configuraci√≥n
      - RABBITMQ_VM_MEMORY_HIGH_WATERMARK=512MiB
      - RABBITMQ_DISK_FREE_LIMIT=2GB
      
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - rabbitmq_logs:/var/log/rabbitmq
    ports:
      # AMQP port (comentar si solo se usa internamente)
      - "${DB_PORT:-5672}:5672"
    labels:
      # Management UI
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq_${APP_NAME}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.rabbitmq_${APP_NAME}.entrypoints=websecure"
      - "traefik.http.routers.rabbitmq_${APP_NAME}.tls.certresolver=letsencrypt"
      - "traefik.http.services.rabbitmq_${APP_NAME}.loadbalancer.server.port=15672"
    networks:
      - appforge-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  rabbitmq_data:
    driver: local
  rabbitmq_logs:
    driver: local

networks:
  appforge-network:
    external: true